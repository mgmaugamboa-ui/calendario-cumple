<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cumplea√±os LT</title>
  <style>
    :root{--blue:#1976d2;--blue2:#1565c0;--ink:#1f2a44;--line:#e3e8f4;--bg:#f4f7fb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:14px 18px}
    h1{margin:0;font-size:1.2rem}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--blue2);background:#2196f3;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .btn.secondary{background:#5b6b95;border-color:#4a587f}
    .btn:hover{background:var(--blue2)}
    .input{padding:6px 10px;border:1px solid #cfd8ea;border-radius:6px}
    main{max-width:980px;margin:0 auto;padding:16px}
    .today-box{background:#fff3cd;border:1px solid #ffe8a1;border-radius:10px;padding:12px;margin:10px 0}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}
    .wday{background:#eef3ff;border:1px solid var(--line);border-radius:6px;padding:8px 6px;text-align:center;font-weight:700;color:#31406e}
    .day{background:#fff;border:1px solid var(--line);min-height:92px;border-radius:6px;padding:6px;position:relative;transition:transform .16s ease, box-shadow .16s ease}
    .day.today{background:#fff9c4}
    .day.zoom{transform:scale(1.25); z-index:5; box-shadow:0 10px 26px rgba(0,0,0,.18)}
    .date{font-weight:700;font-size:.85rem;margin-bottom:4px}
    .event{font-size:.82rem;background:#e3f2fd;margin:2px 0;padding:2px 6px;border-radius:4px;display:flex;justify-content:space-between;gap:6px;align-items:center}
    .event .btn-icon{border:1px solid #cbd5e1;background:#fff;color:#1f2a44;padding:0 6px;border-radius:4px;cursor:pointer}
    .event .btn-icon:hover{background:#eef2ff}
    .event .btn-danger{border:1px solid #e57373;background:#ef9a9a;color:#fff}
    .panel{background:#fff;border:1px dashed #cfd8ea;border-radius:10px;padding:12px;margin:14px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .small{font-size:.9rem;color:#444}
    .list{background:#fff;border:1px solid var(--line);border-radius:10px;margin-top:10px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f9;font-size:.95rem}
    th{background:#eef3ff;text-align:left;color:#31406e}
    .right{text-align:right}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <h1>üéâ Cumplea√±os LT</h1>
    </div>

    <div class="toolbar">
      <button id="prev" class="btn">‚ü® Mes anterior</button>
      <div id="monthTitle" style="font-weight:600"></div>
      <button id="next" class="btn">Mes siguiente ‚ü©</button>
    </div>

    <div class="toolbar">
      <button id="btnViewCal" class="btn">Vista calendario</button>
      <button id="btnViewList" class="btn secondary">Vista lista</button>
      <input id="search" class="input" placeholder="Buscar nombre o correo" />
      <button id="clear" class="btn secondary">Limpiar</button>
    </div>
  </header>

  <main>
    <!-- R√ìTULO: Cumplea√±os de hoy -->
    <section id="today" class="today-box"></section>

    <!-- CABECERA de semana y CALENDARIO -->
    <section id="calHead" class="calendar"></section>
    <section id="calendar" class="calendar"></section>

    <!-- LISTA -->
    <section id="listWrap" class="list hidden">
      <table id="listTable">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Mes</th>
            <th>D√≠a</th>
            <th>Correo electr√≥nico</th>
            <th class="right">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </section>

    <!-- Login edici√≥n simple (SIN CAMBIOS) -->
    <section id="adminLogin" class="panel">
      <div class="row">
        <label>Contrase√±a de edici√≥n (simple):</label>
        <input type="password" id="pwd" class="input" placeholder="Escriba la contrase√±a" />
        <button id="btnPwd" class="btn">Entrar</button>
        <span id="modeLabel">Modo lectura</span>
      </div>
    </section>

    <!-- Panel edici√≥n -->
    <section id="adminPanel" class="panel hidden">
      <h3 id="formTitle" style="margin:0 0 8px 0">Agregar cumplea√±os</h3>
      <div class="row">
        <input type="text" id="name" class="input" placeholder="Nombre" />
        <label>Mes</label>
        <input type="number" id="month" class="input" min="1" max="12" placeholder="MM" style="width:90px" />
        <label>D√≠a</label>
        <input type="number" id="day" class="input" min="1" max="31" placeholder="DD" style="width:90px" />
        <input type="email" id="email" class="input" placeholder="Correo electr√≥nico (opcional)" />
        <button id="btnAdd" class="btn">Agregar</button>
        <button id="btnCancelEdit" class="btn secondary hidden">Cancelar</button>
      </div>

      <h4 style="margin:14px 0 6px 0">Importaci√≥n masiva</h4>
      <p class="small" style="margin:0 0 6px 0">
        Formato: <code>Nombre,MM,DD</code> (opcionalmente <code>,Correo</code>). Use ceros a la izquierda (ej. <code>05</code>).
      </p>
      <textarea id="bulk" rows="5" style="width:100%;padding:8px;border:1px solid #cfd8ea;border-radius:8px"
        placeholder="Ejemplo:
Ana P√©rez,02,11
Luis G√≥mez,08,30,luis@ejemplo.com"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btnBulk" class="btn">‚¨ÜÔ∏è Importar</button>
        <button id="btnLogout" class="btn secondary">Salir de edici√≥n</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase (tu configuraci√≥n)
    const firebaseConfig = {
      apiKey: "AIzaSyAqdejaNqu8YeiOPID6WcGwU6TLpyy_5ew",
      authDomain: "cumplelt-44191.firebaseapp.com",
      projectId: "cumplelt-44191",
      storageBucket: "cumplelt-44191.appspot.com",
      messagingSenderId: "793481323824",
      appId: "1:793481323824:web:d69b527fc2d91555cd94f5"
    };

    // Contrase√±a (SIN CAMBIOS)
    const SECRET = "tarrazu";

    let db = null;
    try { const app = initializeApp(firebaseConfig); db = getFirestore(app); }
    catch (e) { console.warn("Firebase no inicializado todav√≠a.", e); }

    const $=s=>document.querySelector(s);
    const monthTitle=$("#monthTitle"),todayBox=$("#today"),
          calHead=$("#calHead"),calBody=$("#calendar"),
          listWrap=$("#listWrap"),listBody=$("#listBody");

    const weekdays=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
    let allItems=[],isEditor=false,cur=new Date(),curMonth=cur.getMonth(),curYear=cur.getFullYear();
    const pad2=n=>String(n).padStart(2,"0");

    // === Estado de edici√≥n ===
    let editingId = null; // null: agregar; string: id a editar

    function startEdit(rec){
      editingId = rec.id;
      $("#name").value  = rec.name || "";
      $("#email").value = rec.email || "";
      $("#month").value = rec.m || "";
      $("#day").value   = rec.d || "";
      $("#formTitle").textContent = "Editar cumplea√±os";
      $("#btnAdd").textContent = "Guardar cambios";
      $("#btnCancelEdit").classList.remove("hidden");
    }
    function resetForm(){
      editingId = null;
      $("#name").value = $("#email").value = "";
      $("#month").value = $("#day").value = "";
      $("#formTitle").textContent = "Agregar cumplea√±os";
      $("#btnAdd").textContent = "Agregar";
      $("#btnCancelEdit").classList.add("hidden");
    }
    $("#btnCancelEdit").addEventListener("click", resetForm);

    /* ---------- Semana ---------- */
    function renderWeekdays(){
      calHead.innerHTML="";
      for(const w of weekdays){
        const el=document.createElement("div");
        el.className="wday"; el.textContent=w;
        calHead.appendChild(el);
      }
    }

    /* ---------- Calendario con zoom por clic ---------- */
    function renderCalendar(){
      calBody.innerHTML="";
      const first=new Date(curYear,curMonth,1);
      const last=new Date(curYear,curMonth+1,0);
      const startIdx=(first.getDay()+6)%7; // lunes=0
      const daysInMonth=last.getDate();
      monthTitle.textContent=first.toLocaleDateString("es-CR",{month:"long",year:"numeric"});

      for(let i=0;i<startIdx;i++){
        const e=document.createElement("div"); e.className="day"; calBody.appendChild(e);
      }

      for(let d=1; d<=daysInMonth; d++){
        const cell=document.createElement("div"); cell.className="day";
        const now=new Date();
        if(d===now.getDate() && curMonth===now.getMonth() && curYear===now.getFullYear()){cell.classList.add("today");}

        const dateEl=document.createElement("div"); dateEl.className="date"; dateEl.textContent=d; cell.appendChild(dateEl);

        const events=allItems
          .filter(it=>Number(it.m)===curMonth+1 && Number(it.d)===d)
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

        for(const ev of events){
          const e=document.createElement("div"); e.className="event";
          const label=document.createElement("span");
          label.textContent=(ev.name||"") + (ev.email?` ‚Äî ${ev.email}`:"");
          e.appendChild(label);

          if(isEditor){
            const edit=document.createElement("button");
            edit.className="btn-icon";
            edit.textContent="‚úèÔ∏è";
            edit.title="Editar";
            edit.addEventListener("click",(evt)=>{
              evt.stopPropagation();
              startEdit(ev);
              // Asegura que el panel de edici√≥n est√© visible (por si cambiaste de vista)
              $("#adminPanel").classList.remove("hidden");
              $("#adminLogin").classList.add("hidden");
            });
            e.appendChild(edit);

            const del=document.createElement("button");
            del.className="btn-icon btn-danger";
            del.textContent="üóëÔ∏è";
            del.title="Eliminar";
            del.addEventListener("click",(evt)=>{ evt.stopPropagation(); removeBirthday(ev.id); });
            e.appendChild(del);
          }
          cell.appendChild(e);
        }

        // Zoom al clic
        cell.addEventListener("click",()=>{
          document.querySelectorAll(".day.zoom").forEach(el=>el.classList.remove("zoom"));
          cell.classList.add("zoom");
        });

        calBody.appendChild(cell);
      }
    }

    // Quitar zoom al hacer clic fuera
    document.addEventListener("click",(ev)=>{
      if(!ev.target.closest(".day")){
        document.querySelectorAll(".day.zoom").forEach(el=>el.classList.remove("zoom"));
      }
    });

    /* ---------- Lista ---------- */
    function renderList(){
      listBody.innerHTML="";
      let data=[...allItems];
      data.sort((a,b)=> (a.m-b.m) || (a.d-b.d) || (a.name||"").localeCompare(b.name||""));
      const q = ($("#search").value||"").toLowerCase().trim();
      if(q) data=data.filter(x=>(x.name||"").toLowerCase().includes(q) || (x.email||"").toLowerCase().includes(q));

      if(data.length===0){
        const tr=document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center;opacity:.7">Sin datos que mostrar</td>`;
        listBody.appendChild(tr);
        return;
      }

      for(const it of data){
        const tr=document.createElement("tr");
        const acciones = isEditor
          ? `<button class="btn secondary" data-edit="${it.id}">Editar</button>
             <button class="btn secondary" data-del="${it.id}">Eliminar</button>`
          : "";
        tr.innerHTML = `
          <td>${it.name??""}</td>
          <td>${pad2(it.m)}</td>
          <td>${pad2(it.d)}</td>
          <td>${it.email?it.email:""}</td>
          <td class="right">${acciones}</td>
        `;
        listBody.appendChild(tr);
      }
      if(isEditor){
        listBody.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click",()=>removeBirthday(btn.getAttribute("data-del")));
        });
        listBody.querySelectorAll("[data-edit]").forEach(btn=>{
          const id = btn.getAttribute("data-edit");
          btn.addEventListener("click",()=>{
            const rec = allItems.find(x=>x.id===id);
            if(rec) startEdit(rec);
            $("#adminPanel").classList.remove("hidden");
            $("#adminLogin").classList.add("hidden");
          });
        });
      }
    }

    /* ---------- R√≥tulo: Cumplea√±os de hoy ---------- */
    function renderToday(){
      const now=new Date(),m=now.getMonth()+1,d=now.getDate();
      const todays=allItems.filter(it=>Number(it.m)===m&&Number(it.d)===d);
      if(todays.length===0){
        todayBox.innerHTML = `<strong>üéÇ Cumplea√±os de hoy:</strong> No hay cumplea√±os el d√≠a de hoy.`;
      }else{
        todayBox.innerHTML = `<strong>üéÇ Cumplea√±os de hoy:</strong> ${
          todays.map(t=>(t.name||"") + (t.email?` (${t.email})`:"")).join(", ")
        }`;
      }
    }

    /* ---------- B√∫squeda ---------- */
    function applySearch(){
      const gridVisible = !calHead.classList.contains("hidden");
      const q = ($("#search").value||"").toLowerCase().trim();
      if(gridVisible){
        // en calendario ocultamos/mostramos cada evento
        for(const e of calBody.querySelectorAll(".event")){
          const text=e.firstChild.textContent.toLowerCase();
          e.style.display=text.includes(q)?"flex":"none";
        }
      }else{
        renderList();
      }
    }

    /* ---------- Inicial ---------- */
    renderWeekdays(); renderCalendar(); renderToday();

    /* ---------- Firestore: suscripci√≥n (compatibilidad dept‚Üíemail) ---------- */
    if(db){
      onSnapshot(collection(db,"birthdays"),(snap)=>{
        allItems = snap.docs.map(d=>{
          const x = { id:d.id, ...d.data() };
          x.m = Number(x.m);
          x.d = Number(x.d);
          // compatibilidad: si tuvieras documentos antiguos con 'dept'
          x.email = (x.email ?? x.dept ?? "");
          return x;
        });
        renderCalendar(); renderToday(); renderList(); applySearch();
      });
    }

    /* ---------- Navegaci√≥n ---------- */
    $("#prev").addEventListener("click",()=>{curMonth--; if(curMonth<0){curMonth=11;curYear--;} renderCalendar(); applySearch();});
    $("#next").addEventListener("click",()=>{curMonth++; if(curMonth>11){curMonth=0;curYear++;} renderCalendar(); applySearch();});

    /* ---------- Vistas ---------- */
    function showCalendar(){
      calHead.classList.remove("hidden"); calBody.classList.remove("hidden");
      listWrap.classList.add("hidden");
      renderCalendar(); applySearch();
    }
    function showList(){
      calHead.classList.add("hidden"); calBody.classList.add("hidden");
      listWrap.classList.remove("hidden");
      $("#search").value = ""; // limpia filtro para ver siempre datos
      renderList();
    }
    $("#btnViewCal").addEventListener("click",showCalendar);
    $("#btnViewList").addEventListener("click",showList);

    /* ---------- Modo edici√≥n (contrase√±a SIN cambios) ---------- */
    $("#btnPwd").addEventListener("click",()=>{
      if($("#pwd").value.trim()===SECRET){
        isEditor=true;
        $("#adminPanel").classList.remove("hidden");
        $("#adminLogin").classList.add("hidden");
        $("#modeLabel").textContent="Modo edici√≥n";
        renderCalendar(); renderList();
      }else alert("Contrase√±a incorrecta");
    });
    $("#btnLogout").addEventListener("click",()=>{
      isEditor=false;
      $("#adminPanel").classList.add("hidden");
      $("#adminLogin").classList.remove("hidden");
      $("#modeLabel").textContent="Modo lectura";
      resetForm();
      renderCalendar(); renderList();
    });

    /* ---------- AGREGAR / EDITAR ---------- */
    async function addBirthday(){
      if(!isEditor){alert("No autorizado");return;}
      const name  = $("#name").value.trim();
      const m     = Number($("#month").value);
      const d     = Number($("#day").value);
      const email = ($("#email").value || "").trim();

      if(!name||!m||!d){alert("Nombre, mes y d√≠a son obligatorios");return;}
      if(m<1||m>12||d<1||d>31){alert("Mes o d√≠a fuera de rango");return;}
      if(!db){alert("Configura Firebase");return;}

      const payload = { name, m, d, email, md: `${pad2(m)}-${pad2(d)}`, secret: SECRET };

      try{
        if(editingId){
          // EDITAR
          await setDoc(doc(db,"birthdays", editingId), payload, { merge:true });
          resetForm();
        }else{
          // AGREGAR
          await addDoc(collection(db,"birthdays"), payload);
          $("#name").value=$("#month").value=$("#day").value=$("#email").value="";
        }
      }catch(err){
        console.error(err);
        alert("No se pudo guardar. Revisa las reglas de Firestore o la consola para m√°s detalles.");
      }
    }
    $("#btnAdd").addEventListener("click",addBirthday);

    /* ---------- ELIMINAR ---------- */
    async function removeBirthday(id){
      if(!isEditor){alert("No autorizado");return;}
      if(!db){alert("Configura Firebase");return;}
      if(!confirm("¬øEliminar cumplea√±os?")) return;
      try{
        await deleteDoc(doc(db,"birthdays", id));
        if(editingId === id) resetForm();
      }catch(err){
        console.error(err);
        alert("No se pudo eliminar: " + (err?.message || err));
      }
    }

    /* ---------- Importaci√≥n masiva ---------- */
    $("#btnBulk").addEventListener("click",async()=>{
      if(!isEditor){alert("No autorizado");return;}
      if(!db){alert("Configura Firebase");return;}
      const txt=$("#bulk").value.trim(); if(!txt) return;
      const lines=txt.split(/\r?\n/); let ok=0,bad=0;
      for(const line of lines){
        const parts=line.split(",").map(s=>s.trim());
        if(parts.length<3){bad++;continue;}
        const [name,mm,dd,email=""] = parts; const m=Number(mm), d=Number(dd);
        if(!name||!(m>=1&&m<=12)||!(d>=1&&d<=31)){bad++;continue;}
        try{
          await addDoc(collection(db,"birthdays"),{
            name,m,d,email, md: `${pad2(m)}-${pad2(d)}`, secret: SECRET
          });
          ok++;
        }catch{ bad++; }
      }
      alert(`Importaci√≥n completa. OK: ${ok}, errores: ${bad}`);
      $("#bulk").value="";
    });

    /* ---------- B√∫squeda ---------- */
    $("#search").addEventListener("input",applySearch);
    $("#clear").addEventListener("click",()=>{$("#search").value="";applySearch();});
  </script>
</body>
</html>
