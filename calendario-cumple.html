<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario de Cumplea√±os</title>
  <style>
    :root{--blue:#1976d2;--blue2:#1565c0;--ink:#1f2a44;--muted:#5b6b95;--line:#e3e8f4;--bg:#f4f7fb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:14px 18px}
    h1{margin:0;font-size:1.1rem}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar button{border:1px solid var(--blue2);background:#2196f3;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .toolbar button:hover{background:var(--blue2)}
    .input{padding:6px 10px;border:1px solid #cfd8ea;border-radius:6px}
    main{max-width:980px;margin:0 auto;padding:16px}
    .today-box{background:#fff3cd;border:1px solid #ffe8a1;border-radius:10px;padding:12px;margin:10px 0;display:none}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}
    .wday{background:#eef3ff;border:1px solid var(--line);border-radius:6px;padding:8px 6px;text-align:center;font-weight:700;color:#31406e}
    .day{background:#fff;border:1px solid var(--line);min-height:92px;border-radius:6px;padding:6px;position:relative}
    .day.today{background:#fff9c4}
    .date{font-weight:700;font-size:.85rem;margin-bottom:4px}
    .event{font-size:.82rem;background:#e3f2fd;margin:2px 0;padding:2px 6px;border-radius:4px;display:flex;justify-content:space-between;gap:6px;align-items:center}
    .event .del{border:1px solid #e57373;background:#ef9a9a;color:#fff;padding:0 6px;border-radius:4px;cursor:pointer}
    .panel{background:#fff;border:1px dashed #cfd8ea;border-radius:10px;padding:12px;margin:14px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .small{font-size:.9rem;color:#444}
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <h1>üéâ Calendario de Cumplea√±os</h1>
    </div>
    <div class="toolbar">
      <button id="prev">‚ü® Mes anterior</button>
      <div id="monthTitle" style="font-weight:600"></div>
      <button id="next">Mes siguiente ‚ü©</button>
    </div>
    <div class="toolbar">
      <input id="search" class="input" placeholder="Buscar nombre" />
      <button id="clear">Limpiar</button>
    </div>
  </header>

  <main>
    <section id="today" class="today-box"></section>

    <section id="calHead" class="calendar"></section>
    <section id="calendar" class="calendar"></section>

    <!-- Login de edici√≥n simple -->
    <section id="adminLogin" class="panel">
      <div class="row">
        <label>Contrase√±a de edici√≥n (simple):</label>
        <input type="password" id="pwd" class="input" placeholder="Escriba la contrase√±a" />
        <button id="btnPwd">Entrar</button>
        <span id="modeLabel">Modo lectura</span>
      </div>
      <div class="row small">
        ‚ö†Ô∏è Esta modalidad usa una contrase√±a fija <strong>en el navegador</strong> ("tarrazu"). No es tan segura como Firebase Authentication.
      </div>
    </section>

    <!-- Panel de edici√≥n -->
    <section id="adminPanel" class="panel" style="display:none">
      <h3 style="margin:0 0 8px 0">Agregar cumplea√±os</h3>
      <div class="row">
        <input type="text" id="name" class="input" placeholder="Nombre" />
        <label>Mes</label>
        <input type="number" id="month" class="input" min="1" max="12" placeholder="MM" style="width:90px" />
        <label>D√≠a</label>
        <input type="number" id="day" class="input" min="1" max="31" placeholder="DD" style="width:90px" />
        <input type="text" id="dept" class="input" placeholder="Departamento (opcional)" />
        <button id="btnAdd">Agregar</button>
      </div>

      <h4 style="margin:14px 0 6px 0">Importaci√≥n masiva</h4>
      <p class="small" style="margin:0 0 6px 0">
        Formato: <code>Nombre,MM,DD</code> (opcionalmente <code>,Departamento</code>). Use ceros a la izquierda (ej. <code>05</code>).
      </p>
      <textarea id="bulk" rows="5" style="width:100%;padding:8px;border:1px solid #cfd8ea;border-radius:8px"
        placeholder="Ejemplo:
Ana P√©rez,02,11
Luis G√≥mez,08,30,Direcci√≥n"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btnBulk">‚¨ÜÔ∏è Importar</button>
        <button id="btnLogout">Salir de edici√≥n</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PASTE_PROJECT_ID.firebaseapp.com",
      projectId: "PASTE_PROJECT_ID",
      storageBucket: "PASTE_PROJECT_ID.appspot.com",
      messagingSenderId: "PASTE_SENDER_ID",
      appId: "PASTE_APP_ID"
    };

    const SECRET = "tarrazu";

    let db = null;
    let firestoreOk = true;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      firestoreOk = false;
      console.warn("Firebase no inicializado todav√≠a. Se mostrar√° el calendario sin datos.");
    }

    const $ = s => document.querySelector(s);
    const monthTitle = $("#monthTitle");
    const todayBox = $("#today");
    const calHead = $("#calHead");
    const calBody = $("#calendar");
    const weekdays = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];

    let allItems=[];
    let isEditor=false;
    let cur=new Date();
    let curMonth=cur.getMonth();
    let curYear=cur.getFullYear();

    const pad2=n=>String(n).padStart(2,"0");

    function renderWeekdays(){
      calHead.innerHTML="";
      for(const w of weekdays){const el=document.createElement("div");el.className="wday";el.textContent=w;calHead.appendChild(el);}}
    function renderCalendar(){
      calBody.innerHTML="";
      const first=new Date(curYear,curMonth,1);
      const last=new Date(curYear,curMonth+1,0);
      const startIdx=(first.getDay()+6)%7;
      const daysInMonth=last.getDate();
      monthTitle.textContent=first.toLocaleDateString("es-CR",{month:"long",year:"numeric"});
      for(let i=0;i<startIdx;i++){const e=document.createElement("div");e.className="day";calBody.appendChild(e);}
      for(let d=1;d<=daysInMonth;d++){const cell=document.createElement("div");cell.className="day";
        const today=new Date();if(d===today.getDate()&&curMonth===today.getMonth()&&curYear===today.getFullYear()){cell.classList.add("today");}
        const dateEl=document.createElement("div");dateEl.className="date";dateEl.textContent=d;cell.appendChild(dateEl);
        const events=allItems.filter(it=>Number(it.m)===curMonth+1&&Number(it.d)===d).sort((a,b)=>a.name.localeCompare(b.name));
        for(const ev of events){const e=document.createElement("div");e.className="event";const label=document.createElement("span");label.textContent=ev.name+(ev.dept?` ‚Äî ${ev.dept}`:"");e.appendChild(label);
          if(isEditor){const del=document.createElement("button");del.className="del";del.textContent="üóëÔ∏è";del.addEventListener("click",()=>removeBirthday(ev.id));e.appendChild(del);}cell.appendChild(e);}calBody.appendChild(cell);}}
    function renderToday(){const now=new Date();const m=now.getMonth()+1,d=now.getDate();const todays=allItems.filter(it=>Number(it.m)===m&&Number(it.d)===d);
      if(todays.length===0){todayBox.style.display="none";return;}todayBox.style.display="block";todayBox.innerHTML=`<strong>üéÇ Cumplea√±os de hoy:</strong> ${todays.map(t=>t.name).join(", ")}`;}
    function applySearch(){const q=($("#search").value||"").toLowerCase().trim();for(const e of calBody.querySelectorAll(".event")){const text=e.firstChild.textContent.toLowerCase();e.style.display=text.includes(q)?"flex":"none";}}
    renderWeekdays();renderCalendar();renderToday();
    if(firestoreOk&&db){onSnapshot(collection(db,"birthdays"),(snap)=>{allItems=snap.docs.map(d=>({id:d.id,...d.data()}));allItems.forEach(x=>{x.m=Number(x.m);x.d=Number(x.d)});renderCalendar();renderToday();applySearch();});}
    $("#prev").addEventListener("click",()=>{curMonth--;if(curMonth<0){curMonth=11;curYear--;}renderCalendar();applySearch();});
    $("#next").addEventListener("click",()=>{curMonth++;if(curMonth>11){curMonth=0;curYear++;}renderCalendar();applySearch();});
    $("#btnPwd").addEventListener("click",()=>{const val=$("#pwd").value.trim();if(val===SECRET){isEditor=true;$("#adminPanel").style.display="block";$("#adminLogin").style.display="none";$("#modeLabel").textContent="Modo edici√≥n";renderCalendar();}else alert("Contrase√±a incorrecta");});
    $("#btnLogout").addEventListener("click",()=>{isEditor=false;$("#adminPanel").style.display="none";$("#adminLogin").style.display="block";$("#modeLabel").textContent="Modo lectura";renderCalendar();});
    async function addBirthday(){if(!isEditor){alert("No autorizado");return;}const name=$("#name").value.trim();const m=Number($("#month").value);const d=Number($("#day").value);const dept=$("#dept").value.trim();if(!name||!m||!d){alert("Nombre, mes y d√≠a son obligatorios");return;}if(m<1||m>12||d<1||d>31){alert("Mes o d√≠a fuera de rango");return;}if(!db){alert("Configura Firebase");return;}await addDoc(collection(db,"birthdays"),{name,m,d,dept,md:`${pad2(m)}-${pad2(d)}`,secret:SECRET});$("#name").value="";$("#month").value="";$("#day").value="";$("#dept").value="";}
    $("#btnAdd").addEventListener("click",addBirthday);
    async function removeBirthday(id){if(!isEditor){alert("No autorizado");return;}if(!db){alert("Configura Firebase");return;}if(confirm("¬øEliminar cumplea√±os?"))await deleteDoc(doc(db,"birthdays",id));}
    $("#btnBulk").addEventListener("click",async()=>{if(!isEditor){alert("No autorizado");return;}if(!db){alert("Configura Firebase");return;}const txt=$("#bulk").value.trim();if(!txt)return;const lines=txt.split(/\r?\n/);let ok=0,bad=0;for(const line of lines){const parts=line.split(",").map(s=>s.trim());if(parts.length<3){bad++;continue;}const[name,mm,dd,dept=""] = parts;const m=Number(mm),d=Number(dd);if(!name||!(m>=1&&m<=12)||!(d>=1&&d<=31)){bad++;continue;}try{await addDoc(collection(db,"birthdays"),{name,m,d,dept,md:`${pad2(m)}-${pad2(d)}`,secret:SECRET});ok++;}catch{bad++;}}alert(`Importaci√≥n completa. OK: ${ok}, errores: ${bad}`);$("#bulk").value="";});
    $("#search").addEventListener("input",applySearch);$("#clear").addEventListener("click",()=>{$("#search").value="";applySearch();});
  </script>
</body>
</html>